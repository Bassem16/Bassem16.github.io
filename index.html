<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js" type="text/javascript"></script>
  <title>ChamonixNFT · Web3</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <div class="ambient">
    <span class="glow glow-one"></span>
    <span class="glow glow-two"></span>
    <span class="glow glow-three"></span>
  </div>

  <header class="top-bar">
    <div id="connectionStatus" class="status-pill">
      <span class="status-dot"></span>
      <p id="connectionText"></p>
    </div>
    <div class="top-actions">
      <button id="loginButton" class="btn btn-ghost" type="button">
        Connexion MetaMask
      </button>
      <p class="login-info">Connexion sécurisée via MetaMask · vos clés restent privées.</p>
    </div>
  </header>

  <main class="hero">
    <section class="hero-content">
      <div class="badge">ChamonixNFT · Accès Web3</div>
      <h1>Une expérience Web3 élégante pour minter vos NFT.</h1>
      <p>
        Interface moderne et technologique, connexion Web3 instantanée, animations subtiles
        et parcours fluide du login jusqu’au mint.
      </p>

      <div class="cta-row">
        <button id="mintButton" onclick="mint()" class="btn btn-primary" type="button">
          Minter votre NFT
        </button>
        <div class="select-wrapper">
          <label for="numNFTs">Quantité</label>
          <div class="select-shell">
            <select id="numNFTs" name="numNFTs">
              <option>1</option>
              <option>2</option>
              <option>3</option>
              <option>4</option>
              <option>5</option>
            </select>
            <svg viewBox="0 0 20 20" aria-hidden="true">
              <path d="M7 7l3 3 3-3 1 1-4 4-4-4z" />
            </svg>
          </div>
        </div>
      </div>

      <p id="userWallet" class="wallet"></p>
    </section>

    <aside class="hero-card">
      <div class="card-header">
        <span class="card-title">Suivi des transactions</span>
        <span class="card-pill">Goerli</span>
      </div>
      <p class="card-subtitle">Accédez en un clic à vos transactions sur Etherscan.</p>
      <div class="card-footer">
        <img
          src="https://goerli.etherscan.io/assets/svg/logos/logo-etherscan.svg?v=0.0.5"
          alt="Etherscan logo"
        />
        <div id="txContainer" class="tx-link"></div>
      </div>
    </aside>
  </main>

  <footer class="footer">
    <span>Powered by Ethereum · Minting sécurisé</span>
  </footer>

  <script>
	  
    window.userWalletAddress = null
    const loginButton = document.getElementById('loginButton')
    const userWallet = document.getElementById('userWallet')
	const connectionDot = document.querySelector('.status-dot')
    const connectionText = document.getElementById('connectionText')
	const numNFTSelector = document.getElementById("numNFTs")
	const mintButton = document.getElementById('mintButton')
	const txContainer = document.getElementById('txContainer')
	
	connectionText.innerText = 'Non connecté'
	connectionDot.classList.add('status-not-connected')
	txContainer.classList.add("visible");
	
	mintButton.classList.add("disabled");
	mintButton.disabled = true;
	
	numNFTSelector.classList.add("disabled");
	numNFTSelector.disabled = true;
	
	
	
    function toggleButton() {
      if (!window.ethereum) {
        loginButton.innerText = 'MetaMask non installé'
        loginButton.classList.add('disabled')
        loginButton.disabled = true
		
		
        connectionText.innerText = 'Non connecté'
        return false
      }

      loginButton.addEventListener('click', loginWithMetaMask)
    }

    async function loginWithMetaMask() {
	  loginButton.classList.add("disabled");
      loginButton.disabled = true;
	  loginButton.classList.add('loading')
	
      const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' })
        .catch((e) => {
          console.error(e.message)
          return
        })
      if (!accounts) { return }

      window.userWalletAddress = accounts[0]
      userWallet.innerText = window.userWalletAddress
      loginButton.innerText = 'Se déconnecter'
	  
      loginButton.removeEventListener('click', loginWithMetaMask)
      setTimeout(() => {
        loginButton.addEventListener('click', signOutOfMetaMask)
      }, 200)
	 
	 loginButton.classList.remove('loading')
	 connectionDot.classList.remove('status-not-connected')
	 connectionDot.classList.add('status-connected')
	 connectionText.innerText = `Connecté · ${window.userWalletAddress}`
	 
	 loginButton.classList.remove("disabled");
     loginButton.disabled = false;
	 
	 mintButton.classList.remove("disabled");
	 mintButton.disabled = false;
	 numNFTSelector.classList.remove("disabled");
	 numNFTSelector.disabled = false;
	 
	 
	 const url = `https://goerli.etherscan.io/address/0xce16cac9aee306fcc175458ba5a09dd8e8a023ef`
		  
		  // Display the transaction ID as a link below the NFT selector
		  const txLink = document.createElement('a')
		  txLink.href = url
		  txLink.target = '_blank'
		  txLink.innerText = `Transaction ID:`
		  
		  
		  txContainer.appendChild(txLink)
    }

    function signOutOfMetaMask() {
	  loginButton.classList.add("disabled");
      loginButton.disabled = true;
	  loginButton.classList.add('loading')
      window.userWalletAddress = null
      userWallet.innerText = ''
      loginButton.innerText = 'Connexion MetaMask'

      loginButton.removeEventListener('click', signOutOfMetaMask)
      setTimeout(() => {
        loginButton.addEventListener('click', loginWithMetaMask)
      }, 200)
	  loginButton.classList.remove('loading')
	  connectionDot.classList.remove('status-connected')
	  connectionDot.classList.add('status-not-connected')
	  connectionText.innerText = 'Non connecté'
	  
	  loginButton.classList.remove("disabled");
      loginButton.disabled = false;
	  
	 mintButton.classList.add("disabled");
	 mintButton.disabled = true;
	 numNFTSelector.classList.add("disabled");
	 numNFTSelector.disabled = true;
    }

    window.addEventListener('DOMContentLoaded', () => {
      toggleButton()
    });
  </script>
  

    <script>
      const contractAddress = '0xD81689983CaC07a22E13379d18290C0e46a08abA';
      const abi = [
        {
          "inputs": [
            {
              "internalType": "string",
              "name": "name",
              "type": "string"
            },
            {
              "internalType": "string",
              "name": "symbol",
              "type": "string"
            },
            {
              "internalType": "string",
              "name": "_hiddenMetadataUri",
              "type": "string"
            },
            {
              "internalType": "string",
              "name": "_contractUri",
              "type": "string"
            },
            {
              "internalType": "uint256",
              "name": "_mint_price",
              "type": "uint256"
            }
          ],
          "stateMutability": "nonpayable",
          "type": "constructor"
        },
        {
          "inputs": [
            {
              "internalType": "uint256",
              "name": "_amount",
              "type": "uint256"
            }
          ],
          "name": "mintToken",
          "outputs": [],
          "stateMutability": "payable",
          "type": "function"
        }
      ];

      async function mint() {
        try {
		  mintButton.classList.add("disabled");
		  mintButton.disabled = true;
		  mintButton.classList.add('loading')
		  
		  loginButton.classList.add("disabled");
		  loginButton.disabled = true;
		  
          const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
          const web3Provider = new ethers.providers.Web3Provider(window.ethereum);
          const signer = web3Provider.getSigner(accounts[0]);
          const contract = new ethers.Contract(contractAddress, abi, signer);
          const amount = numNFTSelector.value;
          const mintPrice = 0;
		  console.log(amount);
          const value = mintPrice * amount;
          const transaction = await contract.mintToken(amount, { value: value });
          const receipt = await transaction.wait();
		  
          const txId = receipt.transactionHash
          const url = `https://goerli.etherscan.io/tx/${txId}`
	  console.log(url);
		  
		  // Display the transaction ID as a link below the NFT selector
		  // txLink.href = url
		  // txLink.target = '_blank'
		  // txLink.innerText = `Transaction ID: ${txId}`
		  
		  // const txContainer = document.getElementById('txContainer')
		  // txContainer.appendChild(txLink)

		  
		  mintButton.classList.remove('loading')
		  mintButton.classList.remove("disabled");
		  mintButton.disabled = false;
		  
		  loginButton.classList.remove("disabled");
                  loginButton.disabled = false;
          console.log(receipt);
        } catch (error) {
		  mintButton.classList.remove('loading')
		  mintButton.classList.remove("disabled");
		  mintButton.disabled = false;
		  
		  loginButton.classList.remove("disabled");
                  loginButton.disabled = false;
		  
          console.error(error);
        }
      }
    </script>
	
</body>

</html>
